<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>icicle desktop</title>
  <style>
    :root{--bg:#0f1115;--surface:#181c25;--surface-2:#202736;--line:#2e3547;--text:#e6edf3;--muted:#99a3b5;--accent:#3794ff;--accent-2:#1f6feb;--danger:#f14c4c;--ok:#4ec9b0;--shadow:0 14px 34px rgba(0,0,0,.35)}
    body.light{--bg:#e9edf5;--surface:#fff;--surface-2:#f6f8fc;--line:#cfd7e5;--text:#1d2433;--muted:#5e6a80;--accent:#0f62fe;--accent-2:#0956de;--danger:#cc2f45;--ok:#137d68;--shadow:0 12px 26px rgba(17,31,56,.18)}
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1300px 700px at 80% -100px,#22314d 0%,var(--bg) 42%);color:var(--text);font:14px/1.35 "Segoe UI","Verdana",sans-serif}
    .shell{display:grid;grid-template-columns:340px 1fr;gap:14px;padding:14px;min-height:100vh}
    .panel{background:linear-gradient(180deg,var(--surface),var(--surface-2));border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow)}
    .left{padding:14px}.brand{font-size:34px;font-weight:800;letter-spacing:.4px}.sub{color:var(--muted);margin-top:2px}
    .row{display:flex;gap:8px;align-items:center}.stack>*{margin-top:10px}
    input,select,button{border:1px solid var(--line);background:rgba(0,0,0,.08);color:var(--text);border-radius:10px;padding:9px 11px}
    input,select{width:100%} button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));border-color:transparent;color:#fff}
    button.danger{background:var(--danger);border-color:transparent;color:#fff}
    button.ghost{background:transparent}.tiny{font-size:12px;color:var(--muted)}
    .right{display:grid;grid-template-rows:auto 1fr;gap:14px}
    .toolbar{padding:12px;display:grid;grid-template-columns:1fr auto auto auto;gap:8px}
    .drives{display:grid;grid-template-columns:repeat(2,minmax(220px,1fr));gap:10px;padding:12px}
    .drive{border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(0,0,0,.08)}
    .bar{height:8px;background:#293247;border-radius:99px;overflow:hidden;margin-top:8px}.fill{height:100%;background:linear-gradient(90deg,var(--accent),#6cb6ff)}
    .content{display:grid;grid-template-columns:1fr 520px;gap:10px;min-height:0}
    .logWrap,.heavyWrap{padding:12px}.log{height:100%;min-height:430px;border:1px solid var(--line);background:#080c13;color:#d6deeb;border-radius:12px;padding:12px;overflow:auto;white-space:pre-wrap;font:13px/1.42 Consolas,monospace}
    .heavyWrap{overflow:auto}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:600;position:sticky;top:0;background:var(--surface-2)}
    td.pathCell{word-break:break-all}
    td.pathCell .p{display:block;max-height:2.8em;overflow:hidden}
    tr:hover td{background:rgba(255,255,255,.03)}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:4px}
    .actions button{padding:6px 8px;font-size:12px}
    .pill{display:inline-block;padding:3px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    #loader{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    #loader.show{display:flex}
    .spin{width:62px;height:62px;border:4px solid rgba(255,255,255,.2);border-top-color:#7ab5ff;border-radius:50%;animation:rot 1s linear infinite}
    .loadText{margin-top:10px;text-align:center;color:#d9e7ff}
    @keyframes rot{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="loader"><div><div class="spin"></div><div class="loadText" id="loaderText">Сканирование...</div></div></div>
  <div class="shell">
    <aside class="panel left stack">
      <div><div class="brand">icicle</div><div class="sub" id="subtitle">Рабочее приложение</div></div>
      <div class="row"><button class="ghost" id="themeBtn">Light</button><button class="ghost" id="langBtn">EN</button><span class="pill" id="verPill">v-</span></div>
      <div class="tiny" id="folderHint">-</div>
      <div class="row"><input id="path" placeholder="Путь"><button id="browseBtn">...</button></div>
      <div class="row"><select id="saved"></select></div>
      <div class="row"><button id="saveBtn">Сохранить</button><button id="useBtn">Использовать</button><button class="danger" id="removeBtn">Удалить</button></div>
      <div class="row"><input id="topN" value="20"><button class="primary" id="treeBtn">Дерево</button><button class="primary" id="heavyBtn">Тяжёлые</button></div>
      <div class="row"><button class="primary" id="watchStartBtn">Старт слежения</button><button class="danger" id="watchStopBtn">Стоп</button></div>
      <div class="row"><label><input type="checkbox" id="dryRun"> <span id="dryTxt">тестовый режим</span></label></div>
      <div class="row"><label><input type="checkbox" id="fastMode" checked> <span id="fastModeTxt">быстрый режим</span></label></div>
      <div class="row"><input id="maxFiles" value="220000" placeholder="Макс. файлов"><input id="workers" value="24" placeholder="Потоки"></div>
      <div class="row"><button id="undoBtn">Отменить перенос</button><button id="cleanBtn">Пустые папки</button><button id="clearLogBtn">Очистить лог</button></div>
      <div class="row"><button id="expCsvBtn">Экспорт CSV</button><button id="expJsonBtn">JSON</button><button id="expMdBtn">MD</button></div>
      <div class="row"><button id="updCheckBtn">Проверить update</button><button id="updApplyBtn">Обновить</button></div>
      <div class="row"><input id="quickDest" placeholder="Папка для переноса (опционально)"></div>
      <div class="tiny" id="statusLine">готово</div>
    </aside>
    <main class="right">
      <section class="panel">
        <div class="toolbar"><div class="tiny" id="drivesTitle">Место на дисках</div><button id="drivesRefresh">Обновить</button><button id="extBtn">Типы</button><button id="dupBtn">Дубликаты</button></div>
        <div class="drives" id="drives"></div>
      </section>
      <section class="content">
        <div class="panel logWrap"><pre class="log" id="log"></pre></div>
        <div class="panel heavyWrap">
          <table>
            <colgroup>
              <col style="width:92px">
              <col>
              <col style="width:190px">
            </colgroup>
            <thead><tr><th id="thSize">Размер</th><th id="thFile">Файл</th><th id="thAct">Действия</th></tr></thead>
            <tbody id="heavyBody"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>
  <script>
    const el = (id) => document.getElementById(id);
    const s = {lang:"ru",theme:"dark",heavy:[]};
    const i18n = {
      ru:{desktop:"Рабочее приложение",saved:"Сохранённые папки",save:"Сохранить",use:"Использовать",remove:"Удалить",tree:"Дерево",heavy:"Тяжёлые",startWatch:"Старт слежения",stop:"Стоп",dry:"тестовый режим",fast:"быстрый режим",undo:"Отменить перенос",clean:"Пустые папки",clear:"Очистить лог",csv:"Экспорт CSV",updCheck:"Проверить update",updApply:"Обновить",sys:"Место на дисках",refresh:"Обновить",types:"Типы",dups:"Дубликаты",size:"Размер",file:"Файл",act:"Действия",hint:"Тип папки",ready:"готово",running:"слежение активно",open:"Открыть",reveal:"Показать",autoMove:"Авто перенос",moveTo:"Перенести",del:"Удалить",loading:"Сканирование..."},
      en:{desktop:"Desktop App",saved:"Saved folders",save:"Save",use:"Use",remove:"Remove",tree:"Tree",heavy:"Heavy",startWatch:"Start Watch",stop:"Stop",dry:"dry-run",fast:"fast mode",undo:"Undo Move",clean:"Clean Empty",clear:"Clear Log",csv:"Export CSV",updCheck:"Check update",updApply:"Apply update",sys:"System storage",refresh:"Refresh",types:"Extensions",dups:"Duplicates",size:"Size",file:"File",act:"Actions",hint:"Folder type",ready:"ready",running:"watch running",open:"Open",reveal:"Reveal",autoMove:"Auto Move",moveTo:"Move To",del:"Delete",loading:"Scanning..."}
    };
    const tr = (k)=>i18n[s.lang][k]||k;
    const setStatus=(t)=>{el("statusLine").textContent=t;};
    const showLoader=(on,text)=>{el("loader").classList.toggle("show",on); if(text) el("loaderText").textContent=text;};
    const withLoader=async(fn,text)=>{showLoader(true,text||tr("loading")); try{return await fn();} finally{showLoader(false);}};
    function showErr(err){const msg=(err&&err.message)?err.message:String(err||"error");el("log").textContent+="\n[error] "+msg+"\n";setStatus("[error] "+msg);}
    function applyLang(){
      el("subtitle").textContent=tr("desktop"); el("saveBtn").textContent=tr("save"); el("useBtn").textContent=tr("use");
      el("removeBtn").textContent=tr("remove"); el("treeBtn").textContent=tr("tree"); el("heavyBtn").textContent=tr("heavy");
      el("watchStartBtn").textContent=tr("startWatch"); el("watchStopBtn").textContent=tr("stop"); el("dryTxt").textContent=tr("dry");
      el("fastModeTxt").textContent=tr("fast"); el("undoBtn").textContent=tr("undo"); el("cleanBtn").textContent=tr("clean");
      el("clearLogBtn").textContent=tr("clear"); el("expCsvBtn").textContent=tr("csv"); el("updCheckBtn").textContent=tr("updCheck");
      el("updApplyBtn").textContent=tr("updApply"); el("drivesTitle").textContent=tr("sys"); el("drivesRefresh").textContent=tr("refresh");
      el("extBtn").textContent=tr("types"); el("dupBtn").textContent=tr("dups"); el("thSize").textContent=tr("size"); el("thFile").textContent=tr("file");
      el("thAct").textContent=tr("act"); el("quickDest").placeholder=s.lang==="ru"?"Папка для переноса (опционально)":"Move destination (optional)";
      el("saved").setAttribute("data-title",tr("saved")); setStatus(tr("ready")); updateHint();
    }
    function toggleTheme(){s.theme=s.theme==="dark"?"light":"dark";document.body.classList.toggle("light",s.theme==="light");el("themeBtn").textContent=s.theme==="dark"?"Light":"Dark";}
    function toggleLang(){s.lang=s.lang==="ru"?"en":"ru";el("langBtn").textContent=s.lang==="ru"?"EN":"RU";applyLang();renderHeavy();}
    async function updateHint(){try{const kind=await window.go.main.App.FolderHint(el("path").value);el("folderHint").textContent=tr("hint")+": "+kind;}catch{}}
    async function loadDefaults(){const d=await window.go.main.App.Defaults();el("path").value=d.downloads||d.home||"";el("verPill").textContent=d.version||"-";await updateHint();}
    async function loadSaved(){const list=await window.go.main.App.ListSavedFolders();const sel=el("saved");sel.innerHTML="";const o0=document.createElement("option");o0.value="";o0.textContent=tr("saved");sel.appendChild(o0);for(const p of list){const o=document.createElement("option");o.value=p;o.textContent=p;sel.appendChild(o);}}
    async function loadDrives(){return withLoader(async()=>{const items=await window.go.main.App.ListDrives();const wrap=el("drives");wrap.innerHTML="";for(const d of items){const card=document.createElement("div");card.className="drive";const pct=Math.max(0,Math.min(100,Math.round((d.usedRatio||0)*100)));card.innerHTML=`<div class="row" style="justify-content:space-between"><b>${d.drive}</b><span class="tiny">${pct}%</span></div><div>${d.usedHuman} / ${d.totalHuman}</div><div class="bar"><div class="fill" style="width:${pct}%"></div></div><div class="actions" style="margin-top:8px"><button data-use="${d.drive}\\">${tr("use")}</button><button data-open="${d.drive}">${tr("open")}</button><button data-tree="${d.drive}\\">${tr("tree")}</button><button data-heavy="${d.drive}\\">${tr("heavy")}</button></div>`;wrap.appendChild(card);}});}
    async function runTree(){return withLoader(async()=>{const out=await window.go.main.App.RunTree(el("path").value,5,22);el("log").textContent+="\n"+out+"\n";el("log").scrollTop=el("log").scrollHeight;});}
    async function runHeavy(){return withLoader(async()=>{const n=parseInt(el("topN").value||"20",10);const fast=!!el("fastMode").checked;const maxFiles=fast?parseInt(el("maxFiles").value||"220000",10):0;const workers=fast?parseInt(el("workers").value||"24",10):0;const res=await window.go.main.App.RunHeavyFast(el("path").value,n,maxFiles,workers);s.heavy=res.items||[];renderHeavy();setStatus((s.lang==="ru"?"Файлов просмотрено: ":"Seen files: ")+res.seen+(res.limited?(s.lang==="ru"?" (ограничено)":" (limited)"):"")+" | "+res.durationMs+" ms");},tr("loading"));}
    function renderHeavy(){const body=el("heavyBody");body.innerHTML="";for(const it of s.heavy){const trEl=document.createElement("tr");trEl.innerHTML=`<td>${it.human}</td><td class="pathCell" title="${it.path}"><span class="p">${it.path}</span></td><td><div class="actions"><button data-openf="${it.path}">${tr("open")}</button><button data-reveal="${it.path}">${tr("reveal")}</button><button data-amove="${it.path}">${tr("autoMove")}</button><button data-move="${it.path}">${tr("moveTo")}</button><button data-del="${it.path}" style="grid-column:1 / -1">${tr("del")}</button></div></td>`;body.appendChild(trEl);}}
    async function pollLog(){try{const txt=await window.go.main.App.WatchLog();const running=await window.go.main.App.WatchRunning();el("log").textContent=(running?"["+tr("running")+"]\n":"")+txt;el("log").scrollTop=el("log").scrollHeight;}catch(e){showErr(e);}}
    async function moveFile(path,auto){try{let dst="";if(!auto)dst=el("quickDest").value||"";const out=await window.go.main.App.MoveFile(path,dst);setStatus((s.lang==="ru"?"Перенесено -> ":"Moved -> ")+out);await runHeavy();}catch(e){showErr(e);}}
    async function deleteFile(path){try{const safe=confirm(s.lang==="ru"?"Удалить в корзину? OK=в корзину, Cancel=навсегда":"Use recycle bin? OK=safe, Cancel=permanent");await window.go.main.App.DeleteFile(path,safe);setStatus(s.lang==="ru"?"Удалено":"Deleted");await runHeavy();}catch(e){showErr(e);}}
    async function init(){await loadDefaults();await loadSaved();await loadDrives();applyLang();setInterval(pollLog,900);}
    el("themeBtn").onclick=toggleTheme; el("langBtn").onclick=toggleLang;
    el("browseBtn").onclick=async()=>{try{const p=await window.go.main.App.PickFolder();if(p){el("path").value=p;updateHint();}}catch(e){showErr(e);}};
    el("saveBtn").onclick=async()=>{try{await window.go.main.App.SaveFolder(el("path").value);await loadSaved();}catch(e){showErr(e);}};
    el("useBtn").onclick=()=>{if(el("saved").value)el("path").value=el("saved").value;updateHint();};
    el("removeBtn").onclick=async()=>{try{if(el("saved").value){await window.go.main.App.RemoveSavedFolder(el("saved").value);await loadSaved();}}catch(e){showErr(e);}};
    el("treeBtn").onclick=runTree; el("heavyBtn").onclick=runHeavy;
    el("watchStartBtn").onclick=async()=>{try{await window.go.main.App.StartWatch(el("path").value,!!el("dryRun").checked);}catch(e){showErr(e);}};
    el("watchStopBtn").onclick=async()=>{try{await window.go.main.App.StopWatch();}catch(e){showErr(e);}};
    el("undoBtn").onclick=async()=>{try{await window.go.main.App.UndoMove();await runHeavy();}catch(e){showErr(e);}};
    el("cleanBtn").onclick=async()=>{try{const n=await window.go.main.App.CleanEmpty(el("path").value);setStatus((s.lang==="ru"?"Удалено пустых папок: ":"Empty dirs removed: ")+n);}catch(e){showErr(e);}};
    el("clearLogBtn").onclick=async()=>{try{await window.go.main.App.ClearLog();await pollLog();}catch(e){showErr(e);}};
    el("drivesRefresh").onclick=loadDrives;
    el("extBtn").onclick=async()=>{try{const s1=await window.go.main.App.ExtensionStats(el("path").value,20);el("log").textContent+="\n[extensions]\n"+JSON.stringify(s1,null,2)+"\n";}catch(e){showErr(e);}};
    el("dupBtn").onclick=async()=>{try{const s1=await window.go.main.App.DuplicateNames(el("path").value,70000,20);el("log").textContent+="\n[duplicates]\n"+JSON.stringify(s1,null,2)+"\n";}catch(e){showErr(e);}};
    el("expCsvBtn").onclick=async()=>{try{const p=await window.go.main.App.ExportHeavy(el("path").value,parseInt(el("topN").value||"20",10),"csv");if(p)setStatus((s.lang==="ru"?"Экспорт: ":"Exported: ")+p);}catch(e){showErr(e);}};
    el("expJsonBtn").onclick=async()=>{try{const p=await window.go.main.App.ExportHeavy(el("path").value,parseInt(el("topN").value||"20",10),"json");if(p)setStatus((s.lang==="ru"?"Экспорт: ":"Exported: ")+p);}catch(e){showErr(e);}};
    el("expMdBtn").onclick=async()=>{try{const p=await window.go.main.App.ExportHeavy(el("path").value,parseInt(el("topN").value||"20",10),"md");if(p)setStatus((s.lang==="ru"?"Экспорт: ":"Exported: ")+p);}catch(e){showErr(e);}};
    el("updCheckBtn").onclick=async()=>{try{const u=await window.go.main.App.CheckForUpdate();el("log").textContent+="\n[update]\n"+JSON.stringify(u,null,2)+"\n";}catch(e){showErr(e);}};
    el("updApplyBtn").onclick=async()=>{try{const msg=await window.go.main.App.ApplyUpdate();setStatus(msg||"updating...");}catch(e){showErr(e);}};
    el("path").addEventListener("input",()=>updateHint());
    el("drives").addEventListener("click",async(e)=>{const t=e.target;if(!(t instanceof HTMLElement))return;if(t.dataset.use){el("path").value=t.dataset.use;updateHint();}if(t.dataset.open){try{await window.go.main.App.OpenDrive(t.dataset.open);}catch(err){showErr(err);}}if(t.dataset.tree){el("path").value=t.dataset.tree;await runTree();}if(t.dataset.heavy){el("path").value=t.dataset.heavy;await runHeavy();}});
    el("heavyBody").addEventListener("click",async(e)=>{const t=e.target;if(!(t instanceof HTMLElement))return;if(t.dataset.openf){try{await window.go.main.App.OpenPath(t.dataset.openf);}catch(err){showErr(err);}}if(t.dataset.reveal){try{await window.go.main.App.RevealPath(t.dataset.reveal);}catch(err){showErr(err);}}if(t.dataset.amove)await moveFile(t.dataset.amove,true);if(t.dataset.move)await moveFile(t.dataset.move,false);if(t.dataset.del)await deleteFile(t.dataset.del);});
    init().catch(showErr);
  </script>
</body>
</html>
