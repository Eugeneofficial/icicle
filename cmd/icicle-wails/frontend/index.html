<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>icicle desktop</title>
  <style>
    :root{--bg:#0f1115;--surface:#181c25;--surface-2:#202736;--line:#2e3547;--text:#e6edf3;--muted:#99a3b5;--accent:#3794ff;--accent-2:#1f6feb;--danger:#f14c4c;--ok:#4ec9b0;color-scheme:dark}
    body.light{--bg:#e9edf5;--surface:#fff;--surface-2:#f6f8fc;--line:#cfd7e5;--text:#1d2433;--muted:#5e6a80;color-scheme:light}
    *{box-sizing:border-box} body{margin:0;background:radial-gradient(1300px 700px at 80% -100px,#22314d 0%,var(--bg) 42%);color:var(--text);font:14px/1.35 "Segoe UI",sans-serif}
    .shell{display:grid;grid-template-columns:340px 1fr;gap:14px;padding:14px;min-height:100vh}
    .panel{background:linear-gradient(180deg,var(--surface),var(--surface-2));border:1px solid var(--line);border-radius:14px}
    .left{padding:14px}.brand{font-size:34px;font-weight:800}.sub{color:var(--muted)} .row{display:flex;gap:8px;align-items:center}.stack>*{margin-top:10px}
    input,select,button{border:1px solid var(--line);background:rgba(0,0,0,.08);color:var(--text);border-radius:10px;padding:9px 11px}
    select, select option, select optgroup{background:var(--surface);color:var(--text)}
    input,select{width:100%} button{cursor:pointer}.primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));border-color:transparent;color:#fff}.danger{background:var(--danger);border-color:transparent;color:#fff}
    .tiny{font-size:12px;color:var(--muted)} .right{display:grid;grid-template-rows:auto 1fr;gap:14px}
    .toolbar{padding:12px;display:grid;grid-template-columns:1fr auto auto auto auto auto;gap:8px}
    .drives{display:grid;grid-template-columns:repeat(2,minmax(220px,1fr));gap:10px;padding:12px}
    .drive{border:1px solid var(--line);border-radius:12px;padding:10px}.bar{height:8px;background:#293247;border-radius:99px;overflow:hidden;margin-top:8px}.fill{height:100%;background:linear-gradient(90deg,var(--accent),#6cb6ff)}
    .content{display:grid;grid-template-columns:1fr 520px;gap:10px}.logWrap,.heavyWrap{padding:12px}.heavyWrap{max-height:560px;overflow:auto}.log{height:220px;min-height:180px;max-height:320px;resize:vertical;border:1px solid var(--line);background:#080c13;color:#d6deeb;border-radius:12px;padding:10px;overflow:auto;white-space:pre-wrap;font:12px/1.35 Consolas,monospace}
    .heavyWrap{overflow:auto} table{width:100%;border-collapse:collapse;table-layout:fixed} th,td{padding:8px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    th{position:sticky;top:0;background:var(--surface-2);color:var(--muted)}
    td.pathCell{font-family:Consolas,monospace;line-height:1.15;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .actions{display:flex;flex-wrap:nowrap;gap:4px;align-items:center}
    .actions button{padding:4px 7px;font-size:12px;min-width:58px}
    .actions select{width:auto;min-width:126px;padding:4px 6px;font-size:12px}
    .heavyTools{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap}
    .heavyTools .row{margin:0}
    .pill{font-size:12px;border:1px solid var(--line);border-radius:999px;padding:4px 8px;color:var(--muted)}
    .wizWrap{display:grid;grid-template-columns:minmax(0,1fr) 340px;gap:10px;padding:12px}
    .wizMap{height:360px;min-height:300px;border:1px solid var(--line);border-radius:10px;position:relative;overflow:hidden;background:#0b1220}
    .wizRect{position:absolute;overflow:hidden;border:1px solid rgba(255,255,255,.15);font-size:11px;padding:4px;cursor:pointer;white-space:nowrap;text-overflow:ellipsis}
    .wizRect.dir{background:linear-gradient(180deg,#1d3d66,#122944)} .wizRect.file{background:linear-gradient(180deg,#4b2b5a,#2f173b)}
    .wizExt{border:1px solid var(--line);border-radius:10px;overflow:auto;max-height:260px}
    .wizExt table{font-size:12px}
    .wizLegend{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}.wizTag{font-size:11px;border:1px solid var(--line);border-radius:999px;padding:2px 8px}
    .wizTop{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:6px}
    .wizPath{font-family:Consolas,monospace;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    #loader{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}#loader.show{display:flex}.spin{width:62px;height:62px;border:4px solid rgba(255,255,255,.2);border-top-color:#7ab5ff;border-radius:50%;animation:rot 1s linear infinite}.loadText{margin-top:10px;text-align:center;color:#d9e7ff}@keyframes rot{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="loader"><div><div class="spin"></div><div class="loadText" id="loaderText">Scanning...</div></div></div>
  <div class="shell">
    <aside class="panel left stack">
      <div><div class="brand">icicle</div><div class="sub" id="subtitle">Desktop App</div></div>
      <div class="row"><button id="themeBtn">Light</button><button id="langBtn">RU</button><span id="verPill" class="tiny">v-</span></div>
      <div class="tiny" id="folderHint">-</div>
      <div class="row"><input id="path" placeholder="Path"><button id="browseBtn">...</button></div>
      <div class="row"><select id="saved"></select></div>
      <div class="row"><button id="saveBtn">Save</button><button id="useBtn">Use</button><button class="danger" id="removeBtn">Remove</button></div>
      <div class="row"><input id="topN" value="20"><button class="primary" id="treeBtn">Tree</button><button class="primary" id="heavyBtn">Heavy</button></div>
      <div class="row"><button class="primary" id="watchStartBtn">Start Watch</button><button class="danger" id="watchStopBtn">Stop</button></div>
      <div class="row"><label><input type="checkbox" id="dryRun"> <span id="dryTxt">dry-run</span></label></div>
      <div class="row"><label><input type="checkbox" id="fastMode" checked> <span id="fastModeTxt">fast mode</span></label></div>
      <div class="row"><button id="fullScanBtn">Full scan (bg)</button><button id="fullScanCancelBtn">Stop scan</button></div>
      <div class="row"><input id="maxFiles" value="220000" placeholder="Max files"><input id="workers" value="24" placeholder="Workers"></div>
      <div class="row"><input id="scheduleSec" value="300" placeholder="Schedule sec"><button id="scheduleStartBtn">Start schedule</button><button id="scheduleStopBtn">Stop schedule</button></div>
      <div class="row"><button id="scheduleNowBtn">Run schedule now</button><button id="snapshotsBtn">Snapshots</button><button id="historyBtn">Drive history</button></div>
      <div class="row"><button id="diagBtn">Watch diagnostics</button></div>
      <div class="row"><select id="cleanupPreset"><option value="dev-cache">preset: dev-cache</option><option value="games">preset: games</option><option value="media">preset: media</option></select><button id="presetScanBtn">Scan preset</button><button id="presetApplyBtn">Apply preset</button></div>
      <div class="row"><button id="undoBtn">Undo Move</button><button id="cleanBtn">Empty folders</button><button id="clearLogBtn">Clear Log</button></div>
      <div class="row"><button id="expCsvBtn">Export CSV</button><button id="expJsonBtn">JSON</button><button id="expMdBtn">MD</button></div>
      <div class="row"><button id="updCheckBtn">Check update</button><button id="updApplyBtn">Apply update</button></div>
      <div class="row"><input id="quickDest" placeholder="Move destination (optional)"></div>
      <div class="tiny" id="statusLine">ready</div>
    </aside>
    <main class="right">
      <section class="panel">
        <div class="toolbar"><div class="tiny" id="drivesTitle">System storage</div><button id="drivesRefresh">Refresh</button><button id="extBtn">Extensions</button><select id="dupMode"><option value="quick-name">dup: quick</option><option value="hash">dup: hash</option></select><button id="dupBtn">Duplicates</button><button id="wizBtn">WizMap</button></div>
        <div class="drives" id="drives"></div>
      </section>
      <section class="panel wizWrap" id="wizWrap">
        <div>
          <div class="wizTop"><div class="tiny" id="wizTitle">Space Map</div><div class="row"><button id="wizBackBtn">Back</button><button id="wizHomeBtn">Home</button><button id="wizFitBtn">Fit</button><button id="wizToggleSideBtn">Hide Ext</button><label class="tiny"><input id="wizTurbo" type="checkbox"> turbo</label></div></div>
          <div class="wizPath" id="wizPath">-</div>
          <div class="wizLegend" id="wizLegend"></div>
          <div class="wizMap" id="wizMap"></div>
        </div>
        <div id="wizSide">
          <div class="tiny" id="wizExtTitle" style="margin-bottom:6px">Extensions</div>
          <div class="row" style="margin-bottom:6px"><input id="wizExtFilter" placeholder="filter ext"><select id="wizExtSort"><option value="size">size</option><option value="count">count</option><option value="name">name</option></select></div>
          <div class="wizExt"><table><thead><tr><th id="wizThExt">Ext</th><th id="wizThPct">%</th><th id="wizThSize">Size</th><th id="wizThCount">Files</th></tr></thead><tbody id="wizExtBody"></tbody></table></div>
        </div>
      </section>
      <section class="content">
        <div class="panel logWrap"><pre class="log" id="log"></pre></div>
        <div class="panel heavyWrap">
          <div id="driveHistoryPanel" style="display:none;margin-bottom:10px;border:1px solid var(--line);border-radius:10px;padding:8px;background:rgba(0,0,0,.08)">
            <div class="row" style="justify-content:space-between"><b id="historyTitle">Drive history</b><button id="historyCloseBtn">x</button></div>
            <div id="driveHistoryGrid" style="display:grid;grid-template-columns:repeat(2,minmax(220px,1fr));gap:8px;margin-top:6px"></div>
          </div>
          <div id="snapshotPanel" style="display:none;margin-bottom:10px;border:1px solid var(--line);border-radius:10px;padding:8px;background:rgba(0,0,0,.08)">
            <div class="row"><select id="snapA"></select><select id="snapB"></select><button id="snapDiffBtn">Diff</button><button id="snapCloseBtn">x</button></div>
            <pre id="snapDiffOut" style="max-height:160px;overflow:auto;margin:8px 0 0"></pre>
          </div>
          <div id="dupPanel" style="display:none;margin-bottom:10px;border:1px solid var(--line);border-radius:10px;padding:8px;background:rgba(0,0,0,.08)">
            <div class="row"><select id="dupGroupSel"></select><button id="dupKeepNewestBtn">Keep newest</button><button id="dupKeepOldestBtn">Keep oldest</button><button id="dupCloseBtn">x</button></div>
          </div>
          <div id="diagPanel" style="display:none;margin-bottom:10px;border:1px solid var(--line);border-radius:10px;padding:8px;background:rgba(0,0,0,.08)">
            <div class="row" style="justify-content:space-between"><b id="diagTitle">Watch diagnostics</b><button id="diagCloseBtn">x</button></div>
            <div id="diagList" style="max-height:140px;overflow:auto;margin-top:6px"></div>
          </div>
          <div id="presetPanel" style="display:none;margin-bottom:10px;border:1px solid var(--line);border-radius:10px;padding:8px;background:rgba(0,0,0,.08)">
            <div class="row" style="justify-content:space-between"><b id="presetTitle">Preset preview</b><button id="presetCloseBtn">x</button></div>
            <div id="presetSummary" class="tiny" style="margin-top:4px"></div>
            <div id="presetList" style="max-height:140px;overflow:auto;margin-top:6px"></div>
          </div>
          <div class="heavyTools">
            <div class="row"><button id="queueMoveBtn">Queue: move</button><button id="queueDeleteBtn">Queue: delete</button><button id="queueRunBtn">Run queue</button><button id="queueClearBtn">Clear queue</button></div>
            <div class="row"><button id="findEmptyBtn">Find empty folders</button><button id="deleteEmptyBtn">Delete selected empty</button><span class="pill" id="selCount">selected: 0</span></div>
          </div>
          <div id="emptyPanel" style="display:none;margin-bottom:10px;border:1px solid var(--line);border-radius:10px;padding:8px;background:rgba(0,0,0,.08)"><div class="row" style="justify-content:space-between"><b id="emptyTitle">Empty folders</b><label><input id="emptyAll" type="checkbox"> <span id="emptyAllTxt">select all</span></label></div><div id="emptyList" style="max-height:150px;overflow:auto;margin-top:6px"></div></div>
          <table><colgroup><col style="width:30px"><col style="width:90px"><col><col style="width:230px"></colgroup><thead><tr><th><input id="chkAll" type="checkbox"></th><th id="thSize">Size</th><th id="thFile">File</th><th id="thAct">Actions</th></tr></thead><tbody id="heavyBody"></tbody></table>
        </div>
      </section>
    </main>
  </div>

<script>
const el=(id)=>document.getElementById(id);
const s={lang:'en',theme:'dark',heavy:[],queue:[],selected:new Set(),fullPoll:null,emptyDirs:[],emptySelected:new Set(),presetCandidates:[],dupGroups:[],wiz:null,wizPath:'',wizRoot:'',wizStack:[],wizSide:true,busy:false};
const i18n={
  en:{subtitle:'Desktop App',save:'Save',use:'Use',remove:'Remove',tree:'Tree',heavy:'Heavy',start:'Start Watch',stop:'Stop',dry:'dry-run',fast:'fast mode',full:'Full scan (bg)',cancel:'Stop scan',undo:'Undo Move',clean:'Empty folders',clear:'Clear Log',csv:'Export CSV',updCheck:'Check update',updApply:'Apply update',drives:'System storage',refresh:'Refresh',types:'Extensions',dups:'Duplicates',size:'Size',file:'File',act:'Actions',hint:'Folder type',ready:'ready',running:'watch running',open:'Open',reveal:'Reveal',autoMove:'Auto Move',moveTo:'Move To',del:'Delete',loading:'Scanning...',qMove:'Queue: move',qDel:'Queue: delete',qRun:'Run queue',qClear:'Clear queue',findEmpty:'Find empty folders',delEmpty:'Delete selected empty',emptyTitle:'Empty folders',selectAll:'select all',pathPlaceholder:'Move destination (optional)',schedStart:'Start schedule',schedStop:'Stop schedule',schedNow:'Run schedule now',snapshots:'Snapshots',history:'Drive history',presetScan:'Scan preset',presetApply:'Apply preset',diag:'Watch diagnostics',presetPreview:'Preset preview',risk:'risk',dupNewest:'Keep newest',dupOldest:'Keep oldest',wiz:'WizMap',spaceMap:'Space Map',extTable:'Extensions',ext:'Ext',files:'Files',back:'Back',home:'Home',fit:'Fit',hideExt:'Hide Ext',showExt:'Show Ext'},
  ru:{subtitle:'\u0420\u0430\u0431\u043e\u0447\u0435\u0435 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435',save:'\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c',use:'\u0418\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c',remove:'\u0423\u0434\u0430\u043b\u0438\u0442\u044c',tree:'\u0414\u0435\u0440\u0435\u0432\u043e',heavy:'\u0422\u044f\u0436\u0451\u043b\u044b\u0435',start:'\u0421\u0442\u0430\u0440\u0442 \u0441\u043b\u0435\u0436\u0435\u043d\u0438\u044f',stop:'\u0421\u0442\u043e\u043f',dry:'\u0442\u0435\u0441\u0442\u043e\u0432\u044b\u0439 \u0440\u0435\u0436\u0438\u043c',fast:'\u0431\u044b\u0441\u0442\u0440\u044b\u0439 \u0440\u0435\u0436\u0438\u043c',full:'\u041f\u043e\u043b\u043d\u044b\u0439 \u0441\u043a\u0430\u043d (\u0444\u043e\u043d)',cancel:'\u0421\u0442\u043e\u043f \u0441\u043a\u0430\u043d',undo:'\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c \u043f\u0435\u0440\u0435\u043d\u043e\u0441',clean:'\u041f\u0443\u0441\u0442\u044b\u0435 \u043f\u0430\u043f\u043a\u0438',clear:'\u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c \u043b\u043e\u0433',csv:'\u042d\u043a\u0441\u043f\u043e\u0440\u0442 CSV',updCheck:'\u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c update',updApply:'\u041e\u0431\u043d\u043e\u0432\u0438\u0442\u044c',drives:'\u041c\u0435\u0441\u0442\u043e \u043d\u0430 \u0434\u0438\u0441\u043a\u0430\u0445',refresh:'\u041e\u0431\u043d\u043e\u0432\u0438\u0442\u044c',types:'\u0422\u0438\u043f\u044b',dups:'\u0414\u0443\u0431\u043b\u0438\u043a\u0430\u0442\u044b',size:'\u0420\u0430\u0437\u043c\u0435\u0440',file:'\u0424\u0430\u0439\u043b',act:'\u0414\u0435\u0439\u0441\u0442\u0432\u0438\u044f',hint:'\u0422\u0438\u043f \u043f\u0430\u043f\u043a\u0438',ready:'\u0433\u043e\u0442\u043e\u0432\u043e',running:'\u0441\u043b\u0435\u0436\u0435\u043d\u0438\u0435 \u0430\u043a\u0442\u0438\u0432\u043d\u043e',open:'\u041e\u0442\u043a\u0440\u044b\u0442\u044c',reveal:'\u041f\u043e\u043a\u0430\u0437\u0430\u0442\u044c',autoMove:'\u0410\u0432\u0442\u043e \u043f\u0435\u0440\u0435\u043d\u043e\u0441',moveTo:'\u041f\u0435\u0440\u0435\u043d\u0435\u0441\u0442\u0438',del:'\u0423\u0434\u0430\u043b\u0438\u0442\u044c',loading:'\u0421\u043a\u0430\u043d\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435...',qMove:'\u0412 \u043e\u0447\u0435\u0440\u0435\u0434\u044c: \u043f\u0435\u0440\u0435\u043d\u043e\u0441',qDel:'\u0412 \u043e\u0447\u0435\u0440\u0435\u0434\u044c: \u0443\u0434\u0430\u043b\u0435\u043d\u0438\u0435',qRun:'\u0412\u044b\u043f\u043e\u043b\u043d\u0438\u0442\u044c \u043e\u0447\u0435\u0440\u0435\u0434\u044c',qClear:'\u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c \u043e\u0447\u0435\u0440\u0435\u0434\u044c',findEmpty:'\u041d\u0430\u0439\u0442\u0438 \u043f\u0443\u0441\u0442\u044b\u0435 \u043f\u0430\u043f\u043a\u0438',delEmpty:'\u0423\u0434\u0430\u043b\u0438\u0442\u044c \u0432\u044b\u0431\u0440\u0430\u043d\u043d\u044b\u0435 \u043f\u0443\u0441\u0442\u044b\u0435',emptyTitle:'\u041f\u0443\u0441\u0442\u044b\u0435 \u043f\u0430\u043f\u043a\u0438',selectAll:'\u0432\u044b\u0431\u0440\u0430\u0442\u044c \u0432\u0441\u0435',pathPlaceholder:'\u041f\u0430\u043f\u043a\u0430 \u0434\u043b\u044f \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0430 (\u043e\u043f\u0446\u0438\u043e\u043d\u0430\u043b\u044c\u043d\u043e)',schedStart:'\u0421\u0442\u0430\u0440\u0442 \u0440\u0430\u0441\u043f\u0438\u0441\u0430\u043d\u0438\u044f',schedStop:'\u0421\u0442\u043e\u043f \u0440\u0430\u0441\u043f\u0438\u0441\u0430\u043d\u0438\u044f',schedNow:'\u0417\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u044c \u0441\u0435\u0439\u0447\u0430\u0441',snapshots:'\u0421\u043d\u0438\u043c\u043a\u0438',history:'\u0418\u0441\u0442\u043e\u0440\u0438\u044f \u0434\u0438\u0441\u043a\u043e\u0432',presetScan:'\u0421\u043a\u0430\u043d \u043f\u0440\u0435\u0441\u0435\u0442\u0430',presetApply:'\u041f\u0440\u0438\u043c\u0435\u043d\u0438\u0442\u044c \u043f\u0440\u0435\u0441\u0435\u0442',diag:'\u0414\u0438\u0430\u0433\u043d\u043e\u0441\u0442\u0438\u043a\u0430 watch',presetPreview:'\u041f\u0440\u0435\u0432\u044c\u044e \u043f\u0440\u0435\u0441\u0435\u0442\u0430',risk:'\u0440\u0438\u0441\u043a',dupNewest:'\u041e\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u044b\u0439',dupOldest:'\u041e\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u0441\u0442\u0430\u0440\u044b\u0439',wiz:'\u041a\u0430\u0440\u0442\u0430',spaceMap:'\u041a\u0430\u0440\u0442\u0430 \u043c\u0435\u0441\u0442\u0430',extTable:'\u0420\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u0438\u044f',ext:'\u0420\u0430\u0441\u0448\u0438\u0440.',files:'\u0424\u0430\u0439\u043b\u043e\u0432',back:'\u041d\u0430\u0437\u0430\u0434',home:'\u0414\u043e\u043c\u043e\u0439',fit:'\u041f\u043e\u0434\u0433\u043e\u043d\u043a\u0430',hideExt:'\u0421\u043a\u0440\u044b\u0442\u044c ext',showExt:'\u041f\u043e\u043a\u0430\u0437\u0430\u0442\u044c ext'}
};
function lockGlossary(){
  const base=i18n.en||{};
  for(const langKey of Object.keys(i18n)){
    if(langKey==='en') continue;
    const dict=i18n[langKey]||{};
    for(const k of Object.keys(base)){ if(dict[k]===undefined) dict[k]=base[k]; }
    i18n[langKey]=Object.freeze(dict);
  }
  i18n.en=Object.freeze(base);
}
lockGlossary();
const tr=(k)=>i18n[s.lang][k]||k;
const setStatus=(t)=>el('statusLine').textContent=t;
const updateSelCount=()=>{ const n=s.selected.size; if(el('selCount')) el('selCount').textContent=(s.lang==='ru'?'\u0432\u044b\u0431\u0440\u0430\u043d\u043e: ':'selected: ')+n; };
const shortPath=(p,max=78)=>{ if(!p) return ''; if(p.length<=max) return p; const part=Math.max(20,Math.floor((max-3)/2)); return p.slice(0,part)+'...'+p.slice(-part); };
const showLoader=(on,text)=>{el('loader').classList.toggle('show',on); if(text) el('loaderText').textContent=text;};
const withLoader=async(fn,text)=>{
  while(s.busy){
    await new Promise((r)=>setTimeout(r,80));
  }
  s.busy=true;
  showLoader(true,text||tr('loading'));
  try{return await fn();} finally{showLoader(false); s.busy=false;}
};
const showErr=(e)=>{const msg=(e&&e.message)?e.message:String(e||'error'); el('log').textContent+='\n[error] '+msg+'\n'; setStatus('[error] '+msg)};

function applyLang(){
  el('subtitle').textContent=tr('subtitle'); el('saveBtn').textContent=tr('save'); el('useBtn').textContent=tr('use'); el('removeBtn').textContent=tr('remove');
  el('treeBtn').textContent=tr('tree'); el('heavyBtn').textContent=tr('heavy'); el('watchStartBtn').textContent=tr('start'); el('watchStopBtn').textContent=tr('stop');
  el('dryTxt').textContent=tr('dry'); el('fastModeTxt').textContent=tr('fast'); el('fullScanBtn').textContent=tr('full'); el('fullScanCancelBtn').textContent=tr('cancel');
  el('undoBtn').textContent=tr('undo'); el('cleanBtn').textContent=tr('clean'); el('clearLogBtn').textContent=tr('clear'); el('expCsvBtn').textContent=tr('csv');
  el('updCheckBtn').textContent=tr('updCheck'); el('updApplyBtn').textContent=tr('updApply'); el('drivesTitle').textContent=tr('drives'); el('drivesRefresh').textContent=tr('refresh');
  el('extBtn').textContent=tr('types'); el('dupBtn').textContent=tr('dups'); el('thSize').textContent=tr('size'); el('thFile').textContent=tr('file'); el('thAct').textContent=tr('act');
  el('queueMoveBtn').textContent=tr('qMove'); el('queueDeleteBtn').textContent=tr('qDel'); el('queueRunBtn').textContent=tr('qRun'); el('queueClearBtn').textContent=tr('qClear');
  el('findEmptyBtn').textContent=tr('findEmpty'); el('deleteEmptyBtn').textContent=tr('delEmpty'); el('emptyTitle').textContent=tr('emptyTitle'); el('emptyAllTxt').textContent=tr('selectAll');
  el('scheduleStartBtn').textContent=tr('schedStart'); el('scheduleStopBtn').textContent=tr('schedStop'); el('scheduleNowBtn').textContent=tr('schedNow');
  el('snapshotsBtn').textContent=tr('snapshots'); el('historyBtn').textContent=tr('history'); el('presetScanBtn').textContent=tr('presetScan'); el('presetApplyBtn').textContent=tr('presetApply');
  el('diagBtn').textContent=tr('diag'); el('historyTitle').textContent=tr('history'); el('diagTitle').textContent=tr('diag'); el('presetTitle').textContent=tr('presetPreview');
  el('dupKeepNewestBtn').textContent=tr('dupNewest'); el('dupKeepOldestBtn').textContent=tr('dupOldest');
  el('wizBtn').textContent=tr('wiz'); el('wizTitle').textContent=tr('spaceMap'); el('wizExtTitle').textContent=tr('extTable');
  el('wizBackBtn').textContent=tr('back'); el('wizHomeBtn').textContent=tr('home'); el('wizFitBtn').textContent=tr('fit');
  el('wizToggleSideBtn').textContent=s.wizSide?tr('hideExt'):tr('showExt');
  el('wizThExt').textContent=tr('ext'); el('wizThPct').textContent='%'; el('wizThSize').textContent=tr('size'); el('wizThCount').textContent=tr('files');
  el('wizExtFilter').placeholder=s.lang==='ru'?'\u0444\u0438\u043b\u044c\u0442\u0440 ext':'filter ext';
  el('quickDest').placeholder=tr('pathPlaceholder');
  setStatus(tr('ready')); updateHint(); renderHeavy(); renderEmptyDirs(); updateSelCount();
}

function toggleTheme(){s.theme=s.theme==='dark'?'light':'dark'; document.body.classList.toggle('light',s.theme==='light'); el('themeBtn').textContent=s.theme==='dark'?'Light':'Dark';}
function toggleLang(){s.lang=s.lang==='en'?'ru':'en'; el('langBtn').textContent=s.lang==='en'?'RU':'EN'; applyLang();}

async function updateHint(){try{const kind=await window.go.main.App.FolderHint(el('path').value); el('folderHint').textContent=tr('hint')+': '+kind;}catch{}}
async function loadDefaults(){const d=await window.go.main.App.Defaults(); el('path').value=d.downloads||d.home||''; el('verPill').textContent=d.version||'-'; await updateHint();}
async function loadSaved(){const list=await window.go.main.App.ListSavedFolders(); const sel=el('saved'); sel.innerHTML=''; const o0=document.createElement('option'); o0.value=''; o0.textContent=s.lang==='ru'?'\u0421\u043e\u0445\u0440\u0430\u043d\u0451\u043d\u043d\u044b\u0435 \u043f\u0430\u043f\u043a\u0438':'Saved folders'; sel.appendChild(o0); for(const p of list){const o=document.createElement('option'); o.value=p; o.textContent=p; sel.appendChild(o);}}
async function loadDrives(){return withLoader(async()=>{const items=await window.go.main.App.ListDrives(); const wrap=el('drives'); wrap.innerHTML=''; for(const d of items){const pct=Math.max(0,Math.min(100,Math.round((d.usedRatio||0)*100))); const card=document.createElement('div'); card.className='drive'; card.innerHTML=`<div class="row" style="justify-content:space-between"><b>${d.drive}</b><span class="tiny">${pct}%</span></div><div>${d.usedHuman} / ${d.totalHuman}</div><div class="bar"><div class="fill" style="width:${pct}%"></div></div><div class="actions" style="margin-top:8px"><button data-use="${d.drive}\\">${tr('use')}</button><button data-open="${d.drive}">${tr('open')}</button><button data-tree="${d.drive}\\">${tr('tree')}</button><button data-heavy="${d.drive}\\">${tr('heavy')}</button></div>`; wrap.appendChild(card);}});}
async function runTree(){return withLoader(async()=>{const fast=!!el('fastMode').checked; const maxFiles=fast?parseInt(el('maxFiles').value||'220000',10):0; const workers=fast?parseInt(el('workers').value||'24',10):0; const res=await window.go.main.App.RunTreeFast(el('path').value,5,22,maxFiles,workers); el('log').textContent+='\n'+res.output+'\n'; el('log').scrollTop=el('log').scrollHeight; setStatus((s.lang==='ru'?'\u0414\u0435\u0440\u0435\u0432\u043e: ':'Tree: ')+res.seen+(res.limited?(s.lang==='ru'?' (\u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u043e)':' (limited)'):'')+' | '+res.durationMs+' ms'); runWiz();});}
async function runHeavy(){return withLoader(async()=>{const n=parseInt(el('topN').value||'20',10); const fast=!!el('fastMode').checked; const maxFiles=fast?parseInt(el('maxFiles').value||'220000',10):0; const workers=fast?parseInt(el('workers').value||'24',10):0; const res=await window.go.main.App.RunHeavyFast(el('path').value,n,maxFiles,workers); s.heavy=res.items||[]; renderHeavy(); renderWiz({rects:fallbackRectsFromHeavy(),ext:[],total:1}); setStatus((s.lang==='ru'?'\u0424\u0430\u0439\u043b\u043e\u0432 \u043f\u0440\u043e\u0441\u043c\u043e\u0442\u0440\u0435\u043d\u043e: ':'Seen files: ')+res.seen+(res.limited?(s.lang==='ru'?' (\u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u043e)':' (limited)'):'')+' | '+res.durationMs+' ms');},tr('loading'));}
function buildTreemap(rects,w,h){
  const list=(rects||[]).filter(x=>x.size>0).slice().sort((a,b)=>b.size-a.size);
  const out=[];
  const split=(items,x,y,wid,hei,depth)=>{
    if(!items.length||wid<6||hei<6) return;
    if(items.length===1){ out.push({item:items[0],x,y,w:wid,h:hei}); return; }
    const total=items.reduce((s,i)=>s+i.size,0);
    let acc=0, idx=0;
    for(; idx<items.length-1; idx++){ acc+=items[idx].size; if(acc>=total/2) break; }
    const a=items.slice(0,idx+1), b=items.slice(idx+1);
    const vertical = (wid>=hei) ? (depth%2===0) : (depth%2!==0);
    const frac = Math.max(0.1, Math.min(0.9, acc/total));
    if(vertical){
      const wa=Math.max(1,Math.floor(wid*frac));
      split(a,x,y,wa,hei,depth+1);
      split(b,x+wa,y,wid-wa,hei,depth+1);
    } else {
      const ha=Math.max(1,Math.floor(hei*frac));
      split(a,x,y,wid,ha,depth+1);
      split(b,x,y+ha,wid,hei-ha,depth+1);
    }
  };
  split(list,0,0,w,h,0);
  return out;
}
function fallbackRectsFromHeavy(){
  if(!s.heavy||s.heavy.length===0) return [];
  return s.heavy.slice(0,80).map((it)=>({name:(it.path||'').split(/[\\\\/]/).pop()||it.path,path:it.path,kind:'file',size:it.size||0,human:it.human||''}));
}
function colorByName(name){ let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))>>>0; const hue=h%360; return `hsl(${hue} 55% 32%)`; }
function renderWizLegend(rects){
  const wrap=el('wizLegend');
  wrap.innerHTML='';
  const kinds=['dir','file'];
  for(const k of kinds){
    const span=document.createElement('span');
    span.className='wizTag';
    span.textContent=k;
    span.style.background=(k==='dir')?'#163457':'#3a1f49';
    wrap.appendChild(span);
  }
  const byExt={};
  for(const r of rects||[]){
    if(r.kind!=='file') continue;
    const m=(r.name||'').toLowerCase().match(/\.[a-z0-9]+$/);
    const ext=m?m[0]:'(no_ext)';
    byExt[ext]=(byExt[ext]||0)+(r.size||0);
  }
  const top=Object.entries(byExt).sort((a,b)=>b[1]-a[1]).slice(0,6);
  for(const [ext] of top){
    const span=document.createElement('span');
    span.className='wizTag';
    span.textContent=ext;
    span.style.background=colorByName(ext);
    wrap.appendChild(span);
  }
}
function setWizPathLabel(){
  el('wizPath').textContent=s.wizPath||el('path').value||'-';
}
function renderWiz(res){
  s.wiz=res;
  const map=el('wizMap');
  const extBody=el('wizExtBody');
  map.innerHTML='';
  extBody.innerHTML='';
  const w=map.clientWidth||640;
  const h=Math.max(300,map.clientHeight||300);
  const sourceRects=(res.rects&&res.rects.length>0)?res.rects:fallbackRectsFromHeavy();
  const rects=buildTreemap(sourceRects,w,h);
  if(rects.length===0){
    map.innerHTML='<div class="tiny" style="padding:10px">No data yet. Press WizMap.</div>';
    return;
  }
  for(const r of rects){
    if(r.w<8||r.h<8) continue;
    const d=document.createElement('div');
    d.className='wizRect '+(r.item.kind||'file');
    d.style.left=r.x+'px';
    d.style.top=r.y+'px';
    d.style.width=r.w+'px';
    d.style.height=r.h+'px';
    d.style.background=colorByName((r.item.kind||'')+':'+(r.item.name||r.item.path||'x'));
    d.title=`${r.item.name} | ${r.item.human}`;
    if(r.w>65&&r.h>20){
      d.textContent=`${r.item.name} (${r.item.human})`;
    }
    d.onclick=()=>setStatus(`${r.item.name} | ${r.item.human}`);
    d.ondblclick=async()=>{
      try{
        if(r.item.kind==='dir'){
          if(!s.wizRoot){s.wizRoot=el('path').value;}
          s.wizStack.push(s.wizPath||el('path').value);
          await runWiz(r.item.path,false);
        }else{
          await window.go.main.App.RevealPath(r.item.path);
        }
      }catch(e){showErr(e)}
    };
    map.appendChild(d);
  }
  renderWizLegend(sourceRects);
  const total=res.total||1;
  const filter=(el('wizExtFilter').value||'').toLowerCase().trim();
  const sortBy=el('wizExtSort').value||'size';
  const rows=(res.ext||[]).slice().filter(e=>!filter||String(e.ext||'').toLowerCase().includes(filter));
  rows.sort((a,b)=> sortBy==='count' ? (b.count-a.count) : (sortBy==='name' ? String(a.ext).localeCompare(String(b.ext)) : (b.size-a.size)));
  for(const e of rows){
    const trEl=document.createElement('tr');
    const pct=((e.size||0)*100/total).toFixed(1);
    trEl.innerHTML=`<td>${e.ext}</td><td>${pct}%</td><td>${e.human}</td><td>${e.count}</td>`;
    extBody.appendChild(trEl);
  }
  setWizPathLabel();
}
async function runWiz(pathOverride,pushHistory=true){
  return withLoader(async()=>{
    const fast=!!el('fastMode').checked;
    const maxFiles=fast?parseInt(el('maxFiles').value||'220000',10):0;
    const workers=fast?parseInt(el('workers').value||'24',10):0;
    const turbo=!!el('wizTurbo').checked;
    const path=pathOverride||el('path').value;
    if(pushHistory && s.wizPath && path!==s.wizPath){
      s.wizStack.push(s.wizPath);
    }
    s.wizPath=path;
    const res=turbo ? await window.go.main.App.WizMapTurbo(path,maxFiles,32,120,40) : await window.go.main.App.WizMap(path,maxFiles,workers,24,80,25);
    renderWiz(res);
    setStatus((s.lang==='ru'?'\u041a\u0430\u0440\u0442\u0430: ':'WizMap: ')+res.seen+(res.limited?(s.lang==='ru'?' (\u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u043e)':' (limited)'):'')+' | '+res.durationMs+' ms');
  },tr('loading'));
}
function drawSpark(points){ if(!points||points.length===0) return ''; const w=240,h=70,pad=6; const vals=points.map(x=>x.total>0?x.used/x.total:0); let min=1,max=0; for(const v of vals){ if(v<min)min=v; if(v>max)max=v; } if(max===min){max=min+0.01;} const step=(w-pad*2)/Math.max(1,vals.length-1); const pts=vals.map((v,i)=>{const x=pad+i*step; const y=pad+(1-(v-min)/(max-min))*(h-pad*2); return `${x.toFixed(1)},${y.toFixed(1)}`;}).join(' '); return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}"><polyline points="${pts}" fill="none" stroke="#6cb6ff" stroke-width="2"/></svg>`; }
function renderDriveHistory(rows){ const wrap=el('driveHistoryGrid'); wrap.innerHTML=''; for(const r of rows||[]){ const card=document.createElement('div'); card.style.border='1px solid var(--line)'; card.style.borderRadius='10px'; card.style.padding='6px'; const pts=(r.points||[]).slice(-24); card.innerHTML=`<div class="row" style="justify-content:space-between"><b>${r.drive}</b><span class="tiny">${pts.length}</span></div>${drawSpark(pts)}`; wrap.appendChild(card);} }
async function showDriveHistory(){try{const rows=await window.go.main.App.DriveHistory(); if(!rows||rows.length===0){setStatus(s.lang==='ru'?'\u0418\u0441\u0442\u043e\u0440\u0438\u044f \u043f\u0443\u0441\u0442\u0430':'History is empty'); return;} renderDriveHistory(rows); el('driveHistoryPanel').style.display='block';}catch(e){showErr(e)}}
async function listSnapshots(){try{const rows=await window.go.main.App.ListReportSnapshots(40); const a=el('snapA'),b=el('snapB'); a.innerHTML=''; b.innerHTML=''; for(const it of rows||[]){const o=document.createElement('option'); o.value=it.file; o.textContent=it.file.split(/[\\\\/]/).pop(); a.appendChild(o); const o2=o.cloneNode(true); b.appendChild(o2);} if(b.options.length>1) b.selectedIndex=1; el('snapshotPanel').style.display='block';}catch(e){showErr(e)}}
async function diffSnapshots(){try{const left=el('snapA').value,right=el('snapB').value; if(!left||!right){setStatus('select snapshots');return;} const res=await withLoader(()=>window.go.main.App.SnapshotDiff(left,right,40),tr('loading')); el('snapDiffOut').textContent=JSON.stringify(res,null,2);}catch(e){showErr(e)}}
async function startSchedule(){try{const sec=parseInt(el('scheduleSec').value||'300',10); const n=parseInt(el('topN').value||'20',10); const maxFiles=parseInt(el('maxFiles').value||'220000',10); const workers=parseInt(el('workers').value||'24',10); await window.go.main.App.StartScheduledScan(el('path').value,sec,n,maxFiles,workers); setStatus(s.lang==='ru'?'\u0420\u0430\u0441\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u0437\u0430\u043f\u0443\u0449\u0435\u043d\u043e':'Schedule started');}catch(e){showErr(e)}}
async function stopSchedule(){try{await window.go.main.App.StopScheduledScan(); setStatus(s.lang==='ru'?'\u0420\u0430\u0441\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u043e\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d\u043e':'Schedule stopped');}catch(e){showErr(e)}}
async function runScheduleNow(){try{const n=parseInt(el('topN').value||'20',10); const maxFiles=parseInt(el('maxFiles').value||'220000',10); const workers=parseInt(el('workers').value||'24',10); const snap=await withLoader(()=>window.go.main.App.RunScheduledScanOnce(el('path').value,n,maxFiles,workers),tr('loading')); setStatus((s.lang==='ru'?'\u0421\u043d\u0438\u043c\u043e\u043a: ':'Snapshot: ')+snap);}catch(e){showErr(e)}}
function renderPresetPreview(res){ const panel=el('presetPanel'),sum=el('presetSummary'),list=el('presetList'); panel.style.display='block'; sum.textContent=`${res.count} | low:${res.riskLow} medium:${res.riskMedium} high:${res.riskHigh} | ${res.totalHuman}`; list.innerHTML=''; for(const c of (res.candidates||[]).slice(0,80)){ const row=document.createElement('div'); row.className='row'; const color=c.risk==='high'?'#f14c4c':(c.risk==='medium'?'#f2cc60':'#4ec9b0'); row.innerHTML=`<span style="display:inline-block;width:8px;height:8px;border-radius:99px;background:${color}"></span><span class="tiny">${c.human}</span><span class="tiny">${c.risk}</span><span title="${c.path}" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.path}</span>`; list.appendChild(row);} }
async function scanPreset(){try{const preset=el('cleanupPreset').value||'dev-cache'; const res=await withLoader(()=>window.go.main.App.ScanCleanupPreset(el('path').value,preset,120,parseInt(el('maxFiles').value||'220000',10)),tr('loading')); s.presetCandidates=(res&&res.candidates)||[]; renderPresetPreview(res); setStatus((s.lang==='ru'?'\u041a\u0430\u043d\u0434\u0438\u0434\u0430\u0442\u043e\u0432: ':'Candidates: ')+s.presetCandidates.length);}catch(e){showErr(e)}}
async function applyPreset(){try{if(!s.presetCandidates||s.presetCandidates.length===0){setStatus(s.lang==='ru'?'\u041d\u0435\u0442 \u043a\u0430\u043d\u0434\u0438\u0434\u0430\u0442\u043e\u0432':'No preset candidates');return;} const safe=confirm(s.lang==='ru'?'\u0423\u0434\u0430\u043b\u044f\u0442\u044c \u0432 \u043a\u043e\u0440\u0437\u0438\u043d\u0443?':'Use recycle bin?'); const paths=s.presetCandidates.map(x=>x.path); const res=await withLoader(()=>window.go.main.App.ApplyPresetCleanup(paths,safe),tr('loading')); el('log').textContent+='\n[preset-apply]\n'+JSON.stringify(res,null,2)+'\n'; el('log').scrollTop=el('log').scrollHeight; s.presetCandidates=[]; await runHeavy();}catch(e){showErr(e)}}
function renderDupGroups(){ const sel=el('dupGroupSel'); sel.innerHTML=''; for(const g of s.dupGroups){ const o=document.createElement('option'); o.value=g.key; o.textContent=`${g.key} (${g.count})`; sel.appendChild(o);} el('dupPanel').style.display=s.dupGroups.length?'block':'none'; }
async function duplicateKeep(rule){ try{const key=el('dupGroupSel').value; const g=s.dupGroups.find(x=>x.key===key); if(!g){setStatus('group not selected');return;} const safe=confirm(s.lang==='ru'?'\u0423\u0434\u0430\u043b\u044f\u0442\u044c \u0432 \u043a\u043e\u0440\u0437\u0438\u043d\u0443?':'Use recycle bin?'); const res=await withLoader(()=>window.go.main.App.DuplicateKeep(g.paths,rule,safe),tr('loading')); el('log').textContent+='\n[dupe-keep]\n'+JSON.stringify(res,null,2)+'\n'; el('log').scrollTop=el('log').scrollHeight; await runHeavy(); }catch(e){showErr(e)} }
async function watchDiagnostics(){ try{const rows=await window.go.main.App.WatchDiagnostics(el('path').value,32); const list=el('diagList'); list.innerHTML=''; for(const r of rows||[]){ const row=document.createElement('div'); row.className='row'; row.innerHTML=`<span class="tiny">${r.status}</span><span class="tiny">${r.entries||0}</span><span title="${r.path}" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.path}</span>`; list.appendChild(row);} el('diagPanel').style.display='block'; }catch(e){showErr(e)} }
function renderHeavy(){
  const body=el('heavyBody'); body.innerHTML='';
  for(const it of s.heavy){
    const checked=s.selected.has(it.path)?'checked':'';
    const p=shortPath(it.path,84);
    const trEl=document.createElement('tr');
    trEl.innerHTML=`<td><input type="checkbox" data-sel="${it.path}" ${checked}></td><td>${it.human}</td><td class="pathCell" title="${it.path}">${p}</td><td><div class="actions"><button data-openf="${it.path}">${tr('open')}</button><button data-reveal="${it.path}">${tr('reveal')}</button><select data-action-path="${it.path}"><option value="">${tr('act')}</option><option value="amove">${tr('autoMove')}</option><option value="move">${tr('moveTo')}</option><option value="del">${tr('del')}</option></select></div></td>`;
    body.appendChild(trEl);
  }
  el('chkAll').checked=s.heavy.length>0&&s.heavy.every(i=>s.selected.has(i.path));
  updateSelCount();
}
function selectedPaths(){return s.heavy.filter(i=>s.selected.has(i.path)).map(i=>i.path);}
function renderEmptyDirs(){const panel=el('emptyPanel'),list=el('emptyList'); if(!s.emptyDirs||s.emptyDirs.length===0){panel.style.display='none'; list.innerHTML=''; return;} panel.style.display='block'; list.innerHTML=''; for(const p of s.emptyDirs){const row=document.createElement('label'); row.style.display='block'; row.style.marginBottom='4px'; const checked=s.emptySelected.has(p)?'checked':''; row.innerHTML=`<input type="checkbox" data-edir="${p}" ${checked}> <span title="${p}">${p}</span>`; list.appendChild(row);} el('emptyAll').checked=s.emptyDirs.length>0&&s.emptyDirs.every(p=>s.emptySelected.has(p));}
async function runQueue(){if(s.queue.length===0){setStatus(s.lang==='ru'?'\u041e\u0447\u0435\u0440\u0435\u0434\u044c \u043f\u0443\u0441\u0442\u0430\u044f':'Queue is empty'); return;} await withLoader(async()=>{for(const job of s.queue){ if(job.type==='move') await window.go.main.App.BatchMove(job.paths,job.dest,job.auto); if(job.type==='delete') await window.go.main.App.BatchDelete(job.paths,job.safe);} s.queue=[]; s.selected.clear(); await runHeavy();},tr('loading'));}
function startFullScanPoll(){if(s.fullPoll)clearInterval(s.fullPoll); s.fullPoll=setInterval(async()=>{try{const p=await window.go.main.App.GetHeavyFullProgress(); if(p&&p.items&&p.items.length>0){s.heavy=p.items; renderHeavy();} if(p.running)setStatus((s.lang==='ru'?'\u041f\u043e\u043b\u043d\u044b\u0439 \u0441\u043a\u0430\u043d: ':'Full scan: ')+p.seen+' | '+p.durationMs+' ms'); if(p.done){clearInterval(s.fullPoll); s.fullPoll=null;}}catch{}},450);}
async function pollLog(){try{const txt=await window.go.main.App.WatchLog(); const running=await window.go.main.App.WatchRunning(); el('log').textContent=(running?'['+tr('running')+']\n':'')+txt; el('log').scrollTop=el('log').scrollHeight;}catch(e){showErr(e)}}
async function moveFile(path,auto){try{let dst=''; if(!auto) dst=el('quickDest').value||''; await window.go.main.App.MoveFile(path,dst); await runHeavy();}catch(e){showErr(e)}}
async function deleteFile(path){try{const safe=confirm(s.lang==='ru'?'\u0423\u0434\u0430\u043b\u0438\u0442\u044c \u0432 \u043a\u043e\u0440\u0437\u0438\u043d\u0443?':'Use recycle bin?'); await window.go.main.App.DeleteFile(path,safe); await runHeavy();}catch(e){showErr(e)}}

el('themeBtn').onclick=toggleTheme; el('langBtn').onclick=toggleLang;
el('browseBtn').onclick=async()=>{try{const p=await window.go.main.App.PickFolder(); if(p){el('path').value=p; updateHint();}}catch(e){showErr(e)}};
el('saveBtn').onclick=async()=>{try{await window.go.main.App.SaveFolder(el('path').value); await loadSaved();}catch(e){showErr(e)}};
el('useBtn').onclick=()=>{if(el('saved').value)el('path').value=el('saved').value; updateHint();};
el('removeBtn').onclick=async()=>{try{if(el('saved').value){await window.go.main.App.RemoveSavedFolder(el('saved').value); await loadSaved();}}catch(e){showErr(e)}};
el('treeBtn').onclick=runTree; el('heavyBtn').onclick=runHeavy;
el('fullScanBtn').onclick=async()=>{try{await window.go.main.App.StartHeavyFullScan(el('path').value,parseInt(el('topN').value||'20',10)); startFullScanPoll();}catch(e){showErr(e)}};
el('fullScanCancelBtn').onclick=async()=>{try{await window.go.main.App.CancelHeavyFullScan(); if(s.fullPoll){clearInterval(s.fullPoll); s.fullPoll=null;}}catch(e){showErr(e)}};
el('watchStartBtn').onclick=async()=>{try{await window.go.main.App.StartWatch(el('path').value,!!el('dryRun').checked);}catch(e){showErr(e)}};
el('watchStopBtn').onclick=async()=>{try{await window.go.main.App.StopWatch();}catch(e){showErr(e)}};
el('undoBtn').onclick=async()=>{try{await window.go.main.App.UndoMove(); await runHeavy();}catch(e){showErr(e)}};
el('cleanBtn').onclick=()=>el('findEmptyBtn').click();
el('findEmptyBtn').onclick=async()=>{try{const dirs=await withLoader(()=>window.go.main.App.FindEmptyDirs(el('path').value,5000),tr('loading')); s.emptyDirs=dirs||[]; s.emptySelected=new Set(s.emptyDirs); renderEmptyDirs(); setStatus((s.lang==='ru'?'\u041d\u0430\u0439\u0434\u0435\u043d\u043e \u043f\u0443\u0441\u0442\u044b\u0445 \u043f\u0430\u043f\u043e\u043a: ':'Empty folders found: ')+s.emptyDirs.length);}catch(e){showErr(e)}};
el('deleteEmptyBtn').onclick=async()=>{try{const dirs=s.emptyDirs.filter(p=>s.emptySelected.has(p)); if(dirs.length===0){setStatus(s.lang==='ru'?'\u0412\u044b\u0431\u0435\u0440\u0438 \u043f\u0443\u0441\u0442\u044b\u0435 \u043f\u0430\u043f\u043a\u0438':'Select empty folders'); return;} const ok=confirm((s.lang==='ru'?'\u041f\u0435\u0440\u0435\u043c\u0435\u0441\u0442\u0438\u0442\u044c \u0432 \u043a\u043e\u0440\u0437\u0438\u043d\u0443 \u0432\u044b\u0431\u0440\u0430\u043d\u043d\u044b\u0435 \u043f\u0443\u0441\u0442\u044b\u0435 \u043f\u0430\u043f\u043a\u0438: ':'Move selected empty folders to Recycle Bin: ')+dirs.length+'?'); if(!ok)return; const res=await withLoader(()=>window.go.main.App.DeleteEmptyDirsToRecycle(dirs),tr('loading')); setStatus((s.lang==='ru'?'\u0412 \u043a\u043e\u0440\u0437\u0438\u043d\u0443: ':'Moved to Recycle Bin: ')+res.succeeded+'/'+res.processed); el('findEmptyBtn').click();}catch(e){showErr(e)}};
el('clearLogBtn').onclick=async()=>{try{await window.go.main.App.ClearLog(); await pollLog();}catch(e){showErr(e)}};
el('drivesRefresh').onclick=loadDrives; el('extBtn').onclick=async()=>{try{const s1=await window.go.main.App.ExtensionStatsFast(el('path').value,20,parseInt(el('maxFiles').value||'220000',10),parseInt(el('workers').value||'24',10)); el('log').textContent+='\n[extensions]\n'+JSON.stringify(s1,null,2)+'\n';}catch(e){showErr(e)}};
el('dupBtn').onclick=async()=>{try{const mode=el('dupMode').value||'quick-name'; const s1=await window.go.main.App.DuplicateFinderV2(el('path').value,mode,70000,30); s.dupGroups=s1||[]; renderDupGroups(); el('log').textContent+='\n[duplicates:'+mode+']\n'+JSON.stringify(s1,null,2)+'\n';}catch(e){showErr(e)}};
el('wizBtn').onclick=runWiz;
el('wizBackBtn').onclick=async()=>{ if(s.wizStack.length===0) return; const p=s.wizStack.pop(); await runWiz(p,false); };
el('wizHomeBtn').onclick=async()=>{ const p=s.wizRoot||el('path').value; s.wizStack=[]; await runWiz(p,false); };
el('wizFitBtn').onclick=()=>{ if(s.wiz) renderWiz(s.wiz); };
el('wizToggleSideBtn').onclick=()=>{ s.wizSide=!s.wizSide; el('wizSide').style.display=s.wizSide?'block':'none'; el('wizWrap').style.gridTemplateColumns=s.wizSide?'minmax(0,1fr) 340px':'1fr'; el('wizToggleSideBtn').textContent=s.wizSide?tr('hideExt'):tr('showExt'); if(s.wiz) setTimeout(()=>renderWiz(s.wiz),40); };
el('queueMoveBtn').onclick=()=>{const paths=selectedPaths(); if(paths.length===0)return; s.queue.push({type:'move',paths,dest:el('quickDest').value||'',auto:!(el('quickDest').value||'')});};
el('queueDeleteBtn').onclick=()=>{const paths=selectedPaths(); if(paths.length===0)return; const safe=confirm(s.lang==='ru'?'\u0423\u0434\u0430\u043b\u044f\u0442\u044c \u0432 \u043a\u043e\u0440\u0437\u0438\u043d\u0443?':'Use recycle bin for batch delete?'); s.queue.push({type:'delete',paths,safe});};
el('queueRunBtn').onclick=runQueue; el('queueClearBtn').onclick=()=>{s.queue=[]; setStatus(s.lang==='ru'?'\u041e\u0447\u0435\u0440\u0435\u0434\u044c \u043e\u0447\u0438\u0449\u0435\u043d\u0430':'Queue cleared');};
el('expCsvBtn').onclick=async()=>{try{await window.go.main.App.ExportHeavy(el('path').value,parseInt(el('topN').value||'20',10),'csv');}catch(e){showErr(e)}};
el('expJsonBtn').onclick=async()=>{try{await window.go.main.App.ExportHeavy(el('path').value,parseInt(el('topN').value||'20',10),'json');}catch(e){showErr(e)}};
el('expMdBtn').onclick=async()=>{try{await window.go.main.App.ExportHeavy(el('path').value,parseInt(el('topN').value||'20',10),'md');}catch(e){showErr(e)}};
el('updCheckBtn').onclick=async()=>{try{const u=await window.go.main.App.CheckForUpdate(); el('log').textContent+='\n[update]\n'+JSON.stringify(u,null,2)+'\n';}catch(e){showErr(e)}};
el('updApplyBtn').onclick=async()=>{try{const msg=await window.go.main.App.ApplyUpdate(); setStatus(msg||'updating...');}catch(e){showErr(e)}};
el('scheduleStartBtn').onclick=startSchedule; el('scheduleStopBtn').onclick=stopSchedule; el('scheduleNowBtn').onclick=runScheduleNow;
el('snapshotsBtn').onclick=listSnapshots; el('historyBtn').onclick=showDriveHistory;
el('presetScanBtn').onclick=scanPreset; el('presetApplyBtn').onclick=applyPreset;
el('snapDiffBtn').onclick=diffSnapshots;
el('dupKeepNewestBtn').onclick=()=>duplicateKeep('newest'); el('dupKeepOldestBtn').onclick=()=>duplicateKeep('oldest');
el('diagBtn').onclick=watchDiagnostics;
el('wizExtFilter').addEventListener('input',()=>{ if(s.wiz) renderWiz(s.wiz); });
el('wizExtSort').addEventListener('change',()=>{ if(s.wiz) renderWiz(s.wiz); });
el('historyCloseBtn').onclick=()=>el('driveHistoryPanel').style.display='none'; el('snapCloseBtn').onclick=()=>el('snapshotPanel').style.display='none';
el('dupCloseBtn').onclick=()=>el('dupPanel').style.display='none'; el('diagCloseBtn').onclick=()=>el('diagPanel').style.display='none'; el('presetCloseBtn').onclick=()=>el('presetPanel').style.display='none';
el('path').addEventListener('input',updateHint);
el('drives').addEventListener('click',async(e)=>{const t=e.target; if(!(t instanceof HTMLElement))return; if(t.dataset.use){el('path').value=t.dataset.use; updateHint();} if(t.dataset.open){try{await window.go.main.App.OpenDrive(t.dataset.open);}catch(err){showErr(err)}} if(t.dataset.tree){el('path').value=t.dataset.tree; await runTree();} if(t.dataset.heavy){el('path').value=t.dataset.heavy; await runHeavy();}});
el('chkAll').addEventListener('change',(e)=>{const on=e.target.checked; s.selected.clear(); if(on) for(const it of s.heavy) s.selected.add(it.path); renderHeavy();});
el('emptyAll').addEventListener('change',(e)=>{const on=e.target.checked; s.emptySelected.clear(); if(on) for(const p of s.emptyDirs) s.emptySelected.add(p); renderEmptyDirs();});
el('heavyBody').addEventListener('click',async(e)=>{const t=e.target; if(!(t instanceof HTMLElement))return; if(t.dataset.openf){try{await window.go.main.App.OpenPath(t.dataset.openf);}catch(err){showErr(err)}} if(t.dataset.reveal){try{await window.go.main.App.RevealPath(t.dataset.reveal);}catch(err){showErr(err)}} if(t.dataset.amove) await moveFile(t.dataset.amove,true); if(t.dataset.move) await moveFile(t.dataset.move,false); if(t.dataset.del) await deleteFile(t.dataset.del);});
el('heavyBody').addEventListener('change',async(e)=>{
  const t=e.target;
  if(!(t instanceof HTMLElement))return;
  if(t.dataset.sel){
    if(t.checked)s.selected.add(t.dataset.sel); else s.selected.delete(t.dataset.sel);
    el('chkAll').checked=s.heavy.length>0&&s.heavy.every(i=>s.selected.has(i.path));
    updateSelCount();
    return;
  }
  if(t.dataset.actionPath){
    const p=t.dataset.actionPath;
    const act=t.value;
    t.value='';
    if(!act||!p)return;
    if(act==='amove') await moveFile(p,true);
    if(act==='move') await moveFile(p,false);
    if(act==='del') await deleteFile(p);
  }
});
el('emptyList').addEventListener('change',(e)=>{const t=e.target; if(!(t instanceof HTMLElement))return; if(t.dataset.edir){if(t.checked)s.emptySelected.add(t.dataset.edir); else s.emptySelected.delete(t.dataset.edir); el('emptyAll').checked=s.emptyDirs.length>0&&s.emptyDirs.every(p=>s.emptySelected.has(p));}});

(async()=>{try{const d=await window.go.main.App.Defaults(); el('path').value=d.downloads||d.home||''; el('verPill').textContent=d.version||'-'; await loadSaved(); await loadDrives(); applyLang(); setInterval(pollLog,900); setTimeout(()=>runWiz(),250);}catch(e){showErr(e)}})();
window.addEventListener('resize',()=>{ if(s.wiz) renderWiz(s.wiz); });
</script>
</body>
</html>
