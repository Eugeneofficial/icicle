name: CI

permissions:
  contents: write

on:
  push:
  pull_request:
  release:
    types: [published]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      GOFLAGS: -trimpath -buildvcs=false
      CGO_ENABLED: 1
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Format check
        run: |
          files=$(git ls-files '*.go')
          out=$(gofmt -l $files)
          if [ -n "$out" ]; then
            echo "$out"
            echo "Run: gofmt -w <file>"
            exit 1
          fi
      - name: Test
        run: go test ./...
      - name: Glossary QA
        run: python3 scripts/check_glossary.py
      - name: Localization regression
        run: python3 scripts/check_gui_localization.py
      - name: Race (core packages)
        env:
          CGO_ENABLED: 1
        run: go test -race ./internal/scan ./internal/organize

  build-windows:
    runs-on: windows-latest
    timeout-minutes: 10
    env:
      GOFLAGS: -trimpath -buildvcs=false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'
      - name: Build CLI
        run: go build -v -ldflags "-s -w -buildid=" ./cmd/icicle
      - name: Build Desktop
        run: go build -v -ldflags "-s -w -buildid=" -tags "wails,production" ./cmd/icicle-wails

  release-sign:
    if: github.event_name == 'release'
    runs-on: windows-latest
    env:
      GOFLAGS: -trimpath -buildvcs=false
      SIGN_PFX_B64: ${{ secrets.ICICLE_SIGN_PFX_B64 }}
      SIGN_PFX_PASSWORD: ${{ secrets.ICICLE_SIGN_PFX_PASSWORD }}
      SIGN_CERT_SHA1: ${{ secrets.ICICLE_SIGN_CERT_SHA1 }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'
      - name: Build Release Binaries
        shell: pwsh
        run: |
          go build -v -ldflags "-s -w -buildid=" -o icicle.exe ./cmd/icicle
          go build -v -ldflags "-s -w -buildid=" -tags "wails,production" -o icicle-desktop.exe ./cmd/icicle-wails
      - name: Build installer (.exe)
        shell: pwsh
        run: |
          choco install nsis -y --no-progress
          New-Item -ItemType Directory -Path build/bin -Force | Out-Null
          Copy-Item icicle-desktop.exe build/bin/icicle-desktop.exe -Force
          $ver = "${{ github.event.release.tag_name }}".TrimStart("v")
          makensis /DVERSION=$ver scripts/installer.nsi
      - name: Build installer (.msi, WiX alternative)
        shell: pwsh
        continue-on-error: true
        run: |
          $ver = "${{ github.event.release.tag_name }}".TrimStart("v")
          powershell -ExecutionPolicy Bypass -File .\scripts\build_msi_wix.ps1 -Version $ver -SourceDir (Get-Location)
      - name: Sign Binaries (optional)
        if: ${{ env.SIGN_PFX_B64 != '' && env.SIGN_PFX_PASSWORD != '' }}
        shell: pwsh
        run: |
          $pfxPath = Join-Path $env:RUNNER_TEMP "icicle-sign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:SIGN_PFX_B64))
          $secure = ConvertTo-SecureString $env:SIGN_PFX_PASSWORD -AsPlainText -Force
          Import-PfxCertificate -FilePath $pfxPath -CertStoreLocation Cert:\CurrentUser\My -Password $secure | Out-Null
          $thumb = $env:SIGN_CERT_SHA1
          if (-not $thumb) { $thumb = (Get-ChildItem Cert:\CurrentUser\My | Sort-Object NotAfter -Descending | Select-Object -First 1).Thumbprint }
          signtool sign /sha1 $thumb /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 icicle.exe
          signtool sign /sha1 $thumb /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 icicle-desktop.exe
          $installer = Get-ChildItem dist\\*-setup.exe -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($installer) { signtool sign /sha1 $thumb /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 $installer.FullName }
          $msi = Get-ChildItem dist\\*-setup.msi -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($msi) { signtool sign /sha1 $thumb /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 $msi.FullName }
      - name: Package + checksums
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path dist -Force | Out-Null
          Copy-Item icicle.exe dist/icicle.exe
          Copy-Item icicle-desktop.exe dist/icicle-desktop.exe
          $installer = Get-ChildItem dist\\*-setup.exe -ErrorAction SilentlyContinue | Select-Object -First 1
          $msi = Get-ChildItem dist\\*-setup.msi -ErrorAction SilentlyContinue | Select-Object -First 1
          $v = "${{ github.event.release.tag_name }}"
          $zip = "dist/icicle-$v-windows-x64.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          $pack = @(\"dist/icicle.exe\",\"dist/icicle-desktop.exe\")
          if ($installer) { $pack += $installer.FullName }
          if ($msi) { $pack += $msi.FullName }
          Compress-Archive -Path $pack -DestinationPath $zip
          $sha1 = (Get-FileHash dist/icicle.exe -Algorithm SHA256).Hash.ToLower()
          $sha2 = (Get-FileHash dist/icicle-desktop.exe -Algorithm SHA256).Hash.ToLower()
          $shaz = (Get-FileHash $zip -Algorithm SHA256).Hash.ToLower()
          $lines = @(
            "$sha1  icicle.exe",
            "$sha2  icicle-desktop.exe",
            "$shaz  $(Split-Path $zip -Leaf)"
          )
          if ($installer) {
            $shaSetup = (Get-FileHash $installer.FullName -Algorithm SHA256).Hash.ToLower()
            $lines += "$shaSetup  $($installer.Name)"
          }
          if ($msi) {
            $shaMsi = (Get-FileHash $msi.FullName -Algorithm SHA256).Hash.ToLower()
            $lines += "$shaMsi  $($msi.Name)"
          }
          $lines | Set-Content dist/SHA256SUMS.txt
      - name: Release signing report
        if: always()
        shell: pwsh
        run: |
          $summary = New-Object System.Collections.Generic.List[string]
          $summary.Add("## Release Artifact Report")
          $summary.Add("")
          $summary.Add("| Artifact | Exists | Signature verify |")
          $summary.Add("|---|---|---|")
          $targets = @("dist/icicle.exe","dist/icicle-desktop.exe")
          $installer = Get-ChildItem dist\\*-setup.exe -ErrorAction SilentlyContinue | Select-Object -First 1
          $msi = Get-ChildItem dist\\*-setup.msi -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($installer) { $targets += $installer.FullName }
          if ($msi) { $targets += $msi.FullName }
          foreach ($t in $targets) {
            $name = Split-Path $t -Leaf
            if (-not (Test-Path $t)) {
              $summary.Add("| $name | no | n/a |")
              continue
            }
            $verify = "not checked"
            if (Get-Command signtool -ErrorAction SilentlyContinue) {
              & signtool verify /pa $t *> $null
              if ($LASTEXITCODE -eq 0) { $verify = "ok" } else { $verify = "fail" }
            }
            $summary.Add("| $name | yes | $verify |")
          }
          $summary.Add("")
          if (Test-Path "dist/SHA256SUMS.txt") {
            $summary.Add("### SHA256")
            $summary.Add("```text")
            Get-Content dist/SHA256SUMS.txt | ForEach-Object { $summary.Add($_) }
            $summary.Add("```")
          }
          $summary -join \"`n\" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
      - name: Upload release artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/icicle.exe
            dist/icicle-desktop.exe
            dist/*-setup.exe
            dist/*-setup.msi
            dist/*.zip
            dist/SHA256SUMS.txt
